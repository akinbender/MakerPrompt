@page "/fleet"
@page "/"
@* ─────────────────────────────────────────────────────────────────────
   Fleet Dashboard — Main landing page.
   
   Shows all saved printers as cards. Clicking a connected printer opens
   the full Dashboard (ControlPanel / PID / Thermal) inline. Disconnected
   printers show a connect button. Each card has edit/delete actions that
   appear when the card is selected.
   ───────────────────────────────────────────────────────────────────── *@
@using MakerPrompt.Shared.Infrastructure
@using static MakerPrompt.Shared.Utils.Enums
@inject PrinterConnectionManager ConnectionManager
@inject FilamentInventoryService FilamentInventoryService
@inject IAppConfigurationService ConfigService
@inject ISerialService SerialService
@inject IPrinterCameraProvider CameraProvider
@inject IStringLocalizer<Resources> localizer
@inject ToastService ToastService
@inject ILogger<Fleet> Logger
@implements IDisposable

<LocalizedTitle TitleKey="@Resources.PageTitle_Fleet" />

@* ── Selected printer → show Dashboard ── *@
@if (_selectedPrinter?.Service?.IsConnected == true)
{
    <div class="container-fluid">
        <div class="d-flex align-items-center gap-2 mb-3">
            <button class="btn btn-sm btn-outline-secondary" @onclick="DeselectPrinter">
                <i class="bi bi-arrow-left"></i>
            </button>
            <h5 class="mb-0">@_selectedPrinter.Definition.Name</h5>
            <span class="badge bg-success">@_selectedPrinter.Status.GetLocalizedDisplayName()</span>
        </div>
        <ControlPanel />
    </div>
}
else
{
    <div class="container-fluid">
        @* ── Toolbar ── *@
        <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-outline-primary" @onclick="OpenAddModal">
                <i class="bi bi-plus-circle me-1"></i>@localizer[Resources.Fleet_AddPrinter]
            </button>
        </div>

        @if (!ConnectionManager.Printers.Any())
        {
            <div class="alert alert-info d-flex align-items-center">
                <i class="bi bi-info-circle me-2" style="font-size: 1.5rem;"></i>
                <div>
                    @localizer[Resources.Fleet_NoPrinters]
                    <br />
                </div>
            </div>
        }
        else
        {
            <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
                @foreach (var printer in ConnectionManager.Printers)
                {
                    var isSelected = _selectedPrinterId == printer.Definition.Id;
                    <div class="col">
                        <div class="card h-100 @(isSelected ? "border-primary" : "")" style="cursor: pointer;" @onclick="() => SelectPrinter(printer)">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi @GetStatusIcon(printer) @GetStatusColor(printer)"></i>
                                    <strong>@printer.Definition.Name</strong>
                                </div>
                                @if (isSelected)
                                {
                                    <div class="d-flex gap-1" @onclick:stopPropagation="true">
                                        @if (printer.Status == PrinterStatus.Disconnected || printer.Status == PrinterStatus.Error)
                                        {
                                            <button class="btn btn-sm btn-outline-success" @onclick="() => ConnectAsync(printer.Definition.Id)" title="@localizer[Resources.NavConnection_Connect]" disabled="@printer.IsBusy">
                                                @if (printer.IsBusy)
                                                {
                                                    <span class="spinner-border spinner-border-sm"></span>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-plug"></i>
                                                }
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DisconnectAsync(printer.Definition.Id)" title="@localizer[Resources.NavConnection_Disconnect]" disabled="@printer.IsBusy">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        }
                                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => ShowEditForm(printer.Definition)" title="@localizer[Resources.Fleet_EditPrinter]">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeletePrinter(printer.Definition.Id)" title="@localizer[Resources.Fleet_DeletePrinter]">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                }
                            </div>
                            <div class="card-body">
                                @if (printer.Status == PrinterStatus.Disconnected || printer.Status == PrinterStatus.Error)
                                {
                                    <div class="text-center py-4">
                                        <i class="bi bi-plug text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted mt-2">@printer.Status.GetLocalizedDisplayName()</p>
                                        @if (!string.IsNullOrEmpty(printer.LastError))
                                        {
                                            <small class="text-danger d-block">@printer.LastError</small>
                                        }
                                    </div>
                                }
                                else
                                {
                                    @* ── Temperatures ── *@
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <div class="d-flex align-items-center gap-2">
                                                <i class="bi bi-thermometer-half text-danger"></i>
                                                <div>
                                                    <small class="text-muted d-block">@localizer[Resources.PrinterComponent_Hotend]</small>
                                                    <strong>@($"{printer.Telemetry.HotendTemp:F1}°C")</strong>
                                                    <small class="text-muted">&rarr; @($"{printer.Telemetry.HotendTarget:F0}°C")</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="d-flex align-items-center gap-2">
                                                <i class="bi bi-align-bottom text-warning"></i>
                                                <div>
                                                    <small class="text-muted d-block">@localizer[Resources.PrinterComponent_Heatbed]</small>
                                                    <strong>@($"{printer.Telemetry.BedTemp:F1}°C")</strong>
                                                    <small class="text-muted">&rarr; @($"{printer.Telemetry.BedTarget:F0}°C")</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    @* ── Progress ── *@
                                    @if (printer.Telemetry.SDCard.Printing || printer.Status == PrinterStatus.Printing)
                                    {
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <small>@localizer[Resources.Fleet_Progress]</small>
                                                <small>@($"{printer.Telemetry.SDCard.Progress:F0}%")</small>
                                            </div>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                                                     role="progressbar"
                                                     style="width: @($"{printer.Telemetry.SDCard.Progress:F0}%")"
                                                     aria-valuenow="@printer.Telemetry.SDCard.Progress"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                        </div>
                                    }

                                    @* ── Camera Preview ── *@
                                    @if (_cameraUrls.TryGetValue(printer.Definition.Id, out var camUrl) && !string.IsNullOrWhiteSpace(camUrl))
                                    {
                                        <div class="mb-2">
                                            <div class="ratio ratio-16x9 border rounded overflow-hidden">
                                                <img src="@camUrl" alt="Camera" class="object-fit-cover" style="background: #000;" />
                                            </div>
                                        </div>
                                    }

                                    @* ── Assigned Filament ── *@
                                    @if (ConfigService.Configuration.EnableFilamentInventory && printer.Definition.AssignedFilamentSpoolId.HasValue)
                                    {
                                        var spool = FilamentInventoryService.GetSpool(printer.Definition.AssignedFilamentSpoolId.Value);
                                        if (spool != null)
                                        {
                                            <div class="mt-3 pt-3 border-top">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-muted"><i class="bi bi-vinyl-fill me-1"></i>@spool.Name</small>
                                                    <small class="text-muted">@($"{spool.RemainingWeightGrams:F0}g / {spool.TotalWeightGrams:F0}g")</small>
                                                </div>
                                                <div class="progress mt-1" style="height: 4px;">
                                                    <div class="progress-bar @(spool.RemainingWeightGrams < spool.TotalWeightGrams * 0.1 ? "bg-danger" : "bg-info")"
                                                         role="progressbar"
                                                         style="width: @($"{(spool.RemainingWeightGrams / spool.TotalWeightGrams) * 100:F0}%")">
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }

        @* ── Print Queue ── *@
        <div class="mt-4">
            <PrintQueue />
        </div>
    </div>
}

@* ── Add / Edit Printer Modal ── *@
<Modal @ref="_addEditModal" Title="@(_isEditing ? localizer[Resources.Fleet_EditPrinter] : localizer[Resources.Fleet_AddPrinter])" Size="ModalSize.Regular">
    <BodyTemplate>
        <div class="mb-3">
            <label class="form-label">@localizer[Resources.Fleet_PrinterName]</label>
            <input type="text" class="form-control" @bind="_editDefinition.Name" placeholder="My 3D Printer" />
        </div>

        <div class="mb-3">
            <label class="form-label">@localizer[Resources.Fleet_ConnectionType]</label>
            <select class="form-select" @bind="_editConnectionType">
                @foreach (var ct in _connectionTypes)
                {
                    <option value="@ct">@ct.GetDisplayName()</option>
                }
            </select>
        </div>

        @if (_editConnectionType == PrinterConnectionType.Serial)
        {
            <div class="mb-3">
                <div class="input-group input-group-sm">
                    <span class="input-group-text">Port</span>
                    <select class="form-select" @bind="_editSerialSettings.PortName">
                        <option value="">@localizer[Resources.NavConnection_SelectPort]</option>
                        @foreach (var port in _availablePorts)
                        {
                            <option value="@port">@port</option>
                        }
                    </select>
                    <button class="btn btn-outline-secondary" type="button" @onclick="RefreshPortsAsync">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="mb-3">
                <div class="input-group input-group-sm">
                    <select class="form-select" @bind="_editSerialSettings.BaudRate">
                        @foreach (var rate in BaudRates)
                        {
                            <option value="@rate">@rate</option>
                        }
                    </select>
                    <span class="input-group-text">bps</span>
                </div>
            </div>
        }
        else if (_editConnectionType == PrinterConnectionType.Demo)
        {
            <div class="alert alert-info">
                <p class="mb-0">@localizer[Resources.NavConnection_DemoServiceDescription]</p>
            </div>
        }
        else
        {
            <div class="mb-3">
                <label class="form-label">URL</label>
                <input type="text" class="form-control" @bind="_editApiSettings.Url" placeholder="http://192.168.1.100" />
            </div>

            @if (_editConnectionType == PrinterConnectionType.BambuLab)
            {
                <div class="mb-3">
                    <label class="form-label">Serial Number</label>
                    <input type="text" class="form-control" @bind="_editApiSettings.UserName" placeholder="Enter printer serial number" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Access Code</label>
                    <input type="password" class="form-control" @bind="_editApiSettings.Password" placeholder="Enter access code" />
                </div>
            }
            else if (_editConnectionType == PrinterConnectionType.OctoPrint)
            {
                <div class="mb-3">
                    <label class="form-label">API Key</label>
                    <input type="password" class="form-control" @bind="_editApiSettings.Password" placeholder="Enter OctoPrint API key" />
                </div>
            }
            else
            {
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" @bind="_editApiSettings.UserName" placeholder="Username" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Password / API Key</label>
                    <input type="password" class="form-control" @bind="_editApiSettings.Password" placeholder="Password or API key" />
                </div>
            }
        }

        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="autoConnect" @bind="_editDefinition.AutoConnect" />
            <label class="form-check-label" for="autoConnect">@localizer[Resources.Fleet_AutoConnect]</label>
        </div>

        @if (ConfigService.Configuration.EnableFilamentInventory)
        {
            <div class="mb-3">
                <label class="form-label">Assigned Filament Spool</label>
                <select class="form-select" @bind="_editDefinition.AssignedFilamentSpoolId">
                    <option value="">None</option>
                    @foreach (var spool in FilamentInventoryService.GetSpools())
                    {
                        <option value="@spool.Id">@spool.Name (@spool.Material - @spool.Color)</option>
                    }
                </select>
            </div>
        }
    </BodyTemplate>
    <FooterTemplate>
        <button class="btn btn-outline-secondary" @onclick="CloseAddEditModal">@localizer[Resources.Fleet_Cancel]</button>
        <button class="btn btn-outline-primary" @onclick="SavePrinterAsync">@localizer[Resources.Fleet_Save]</button>
    </FooterTemplate>
</Modal>

@code {
    private readonly Dictionary<Guid, string?> _cameraUrls = new();

    // Selection state
    private Guid? _selectedPrinterId;
    private ManagedPrinterState? _selectedPrinter;

    // Add/Edit modal state
    private Modal _addEditModal = default!;
    private bool _isEditing;
    private PrinterConnectionDefinition _editDefinition = new();
    private ApiConnectionSettings _editApiSettings = new();
    private SerialConnectionSettings _editSerialSettings = new();
    private PrinterConnectionType _editConnectionType = PrinterConnectionType.Demo;
    private List<string> _availablePorts = new();
    private readonly List<int> BaudRates = [9600, 19200, 38400, 57600, 115200, 250000];
    private readonly PrinterConnectionType[] _connectionTypes = Enum.GetValues<PrinterConnectionType>();

    protected override void OnInitialized()
    {
        ConnectionManager.PrintersChanged += HandlePrintersChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RefreshCameraUrlsAsync();
        }
    }

    private async void HandlePrintersChanged(object? sender, EventArgs e)
    {
        // Keep selected printer reference fresh
        if (_selectedPrinterId.HasValue)
        {
            _selectedPrinter = ConnectionManager.Printers.FirstOrDefault(p => p.Definition.Id == _selectedPrinterId);
            if (_selectedPrinter == null)
                _selectedPrinterId = null;
        }

        await RefreshCameraUrlsAsync();
        await InvokeAsync(StateHasChanged);
    }

    // ── Selection ──
    private void SelectPrinter(ManagedPrinterState printer)
    {
        if (_selectedPrinterId == printer.Definition.Id && printer.Service?.IsConnected != true)
        {
            // Clicking the already-selected card again deselects it
            _selectedPrinterId = null;
            _selectedPrinter = null;
            return;
        }

        _selectedPrinterId = printer.Definition.Id;
        _selectedPrinter = printer;

        // If connected, sync to factory so Dashboard/ControlPanel/CommandPrompt work
        if (printer.Service?.IsConnected == true)
        {
            ConnectionManager.SetActivePrinter(printer.Definition.Id);
        }
    }

    private void DeselectPrinter()
    {
        _selectedPrinterId = null;
        _selectedPrinter = null;
    }

    // ── Camera ──
    private async Task RefreshCameraUrlsAsync()
    {
        foreach (var printer in ConnectionManager.Printers)
        {
            if (printer.Service == null || !printer.Service.IsConnected)
            {
                _cameraUrls.Remove(printer.Definition.Id);
                continue;
            }

            try
            {
                IReadOnlyList<PrinterCamera> cameras = printer.Service switch
                {
                    MoonrakerApiService moonraker => await moonraker.GetCamerasAsync(),
                    OctoPrintApiService octoprint => await octoprint.GetCamerasAsync(),
                    BambuLabApiService bambu => await bambu.GetCamerasAsync(),
                    PrusaLinkApiService prusa => await prusa.GetCamerasAsync(),
                    _ => Array.Empty<PrinterCamera>()
                };

                var cam = cameras.FirstOrDefault();
                _cameraUrls[printer.Definition.Id] = cam?.StreamUrl ?? cam?.SnapshotUrl;
            }
            catch
            {
                _cameraUrls.Remove(printer.Definition.Id);
            }
        }
    }

    // ── Connection actions ──
    private async Task ConnectAsync(Guid id)
    {
        try { await ConnectionManager.ConnectPrinterAsync(id); }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fleet: connect failed");
            ToastService.Notify(new ToastMessage(ToastType.Danger, "Connection failed", ex.Message));
        }
    }

    private async Task DisconnectAsync(Guid id)
    {
        try { await ConnectionManager.DisconnectPrinterAsync(id); }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fleet: disconnect failed");
            ToastService.Notify(new ToastMessage(ToastType.Danger, "Disconnect failed", ex.Message));
        }
    }

    // ── Add/Edit modal ──
    private async Task OpenAddModal()
    {
        _isEditing = false;
        _editDefinition = new PrinterConnectionDefinition();
        _editApiSettings = new ApiConnectionSettings();
        _editSerialSettings = new SerialConnectionSettings();
        _editConnectionType = PrinterConnectionType.Demo;
        await _addEditModal.ShowAsync();
    }

    private async Task ShowEditForm(PrinterConnectionDefinition definition)
    {
        _isEditing = true;
        _editDefinition = new PrinterConnectionDefinition
        {
            Id = definition.Id,
            Name = definition.Name,
            ConnectionType = definition.ConnectionType,
            AutoConnect = definition.AutoConnect,
            Color = definition.Color,
            Notes = definition.Notes,
            CreatedAt = definition.CreatedAt,
            LastConnectedAt = definition.LastConnectedAt
        };
        _editConnectionType = definition.ConnectionType;
        _editApiSettings = definition.Settings.Api is not null
            ? new ApiConnectionSettings(definition.Settings.Api.Url, definition.Settings.Api.UserName, definition.Settings.Api.Password)
            : new ApiConnectionSettings();
        _editSerialSettings = definition.Settings.Serial is not null
            ? new SerialConnectionSettings { PortName = definition.Settings.Serial.PortName, BaudRate = definition.Settings.Serial.BaudRate }
            : new SerialConnectionSettings();
        await _addEditModal.ShowAsync();
    }

    private async Task CloseAddEditModal()
    {
        await _addEditModal.HideAsync();
    }

    private async Task SavePrinterAsync()
    {
        if (string.IsNullOrWhiteSpace(_editDefinition.Name))
        {
            ToastService.Notify(new ToastMessage(ToastType.Warning, "Printer name is required"));
            return;
        }

        _editDefinition.ConnectionType = _editConnectionType;
        _editDefinition.Settings = _editConnectionType switch
        {
            PrinterConnectionType.Serial => new PrinterConnectionSettings(_editSerialSettings),
            PrinterConnectionType.Demo => new PrinterConnectionSettings(),
            _ => new PrinterConnectionSettings(_editApiSettings, _editConnectionType)
        };

        try
        {
            if (_isEditing)
            {
                await ConnectionManager.UpdatePrinterAsync(_editDefinition);
                ToastService.Notify(new ToastMessage(ToastType.Success, "Printer updated"));
            }
            else
            {
                await ConnectionManager.AddPrinterAsync(_editDefinition);
                ToastService.Notify(new ToastMessage(ToastType.Success, "Printer added"));
            }
            await _addEditModal.HideAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save printer definition");
            ToastService.Notify(new ToastMessage(ToastType.Danger, "Failed to save printer", ex.Message));
        }
    }

    private async Task DeletePrinter(Guid id)
    {
        try
        {
            await ConnectionManager.RemovePrinterAsync(id);
            if (_selectedPrinterId == id)
            {
                _selectedPrinterId = null;
                _selectedPrinter = null;
            }
            ToastService.Notify(new ToastMessage(ToastType.Success, "Printer removed"));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to delete printer");
            ToastService.Notify(new ToastMessage(ToastType.Danger, "Delete failed", ex.Message));
        }
    }

    private async Task RefreshPortsAsync()
    {
        try
        {
            _availablePorts = (await SerialService.GetAvailablePortsAsync()).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to enumerate serial ports");
            ToastService.Notify(new ToastMessage(ToastType.Warning, "Could not refresh ports", ex.Message));
        }
    }

    // ── Helpers ──
    private static string GetStatusIcon(ManagedPrinterState printer)
    {
        return printer.Status switch
        {
            PrinterStatus.Connected => "bi-check-circle-fill",
            PrinterStatus.Printing => "bi-play-circle-fill",
            PrinterStatus.Paused => "bi-pause-circle-fill",
            PrinterStatus.Error => "bi-exclamation-circle-fill",
            _ => "bi-dash-circle"
        };
    }

    private static string GetStatusColor(ManagedPrinterState printer)
    {
        return printer.Status switch
        {
            PrinterStatus.Connected => "text-success",
            PrinterStatus.Printing => "text-primary",
            PrinterStatus.Paused => "text-warning",
            PrinterStatus.Error => "text-danger",
            _ => "text-muted"
        };
    }

    public void Dispose()
    {
        ConnectionManager.PrintersChanged -= HandlePrintersChanged;
    }
}
