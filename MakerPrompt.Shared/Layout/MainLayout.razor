@inject IStringLocalizer<Resources> localizer
@inject IAppConfigurationService ConfigService
@inherits LayoutComponentBase
@implements IDisposable

<header class="navbar sticky-top bg-body-secondary text-body flex-md-nowrap p-0 shadow">
    <a href="/" class="navbar-brand bg-body-tertiary d-flex align-items-center me-0 px-2 @(_navCollapsed ? "brand--collapsed" : "")">
        <img class="ms-2" width="40" height="32" aria-hidden="true" src="_content/MakerPrompt.Shared/logo.svg" onerror="this.src='_content/MakerPrompt.Shared/favicon.png'" />
        <span class="brand-label">@(string.IsNullOrWhiteSpace(ConfigService.Configuration.FarmName) ? "MakerPrompt" : ConfigService.Configuration.FarmName)</span>
    </a>
    <NavTop />
</header>

<div class="layout-body">
    <NavMenu Collapsed="_navCollapsed" OnToggle="ToggleSidebar" />
    <main class="layout-main h-100">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom px-4">
            <h1 class="h2">@TitleService.CurrentTitle</h1>
        </div>
        <div class="layout-content @(_isResizing ? "resizing" : "")" @onmousemove="OnMouseMove" @onmouseup="OnMouseUp" @onmouseleave="OnMouseUp">
            <div class="layout-page">
                @Body
            </div>
            <div class="layout-resizer @(_isResizing ? "active" : "")" @onmousedown="OnMouseDown"></div>
            <div class="layout-right" style="--layout-right-width: @(_rightPanelWidth)px;">
                <div class="layout-right-top">
                    <CommandPrompt />
                </div>
                <div class="layout-right-bottom">
                    <GCodeViewer />
                </div>
            </div>
        </div>
    </main>
</div>

<Toasts class="p-3" AutoHide="true" Delay="8000" Placement="ToastsPlacement.BottomRight" />

@code {
    [Inject]
    private LocalizedTitleService TitleService { get; set; } = null!;

    private bool _navCollapsed = false;
    private bool _isResizing = false;
    private double _rightPanelWidth = 600; // Default width in pixels
    private double _startX;
    private double _startWidth;

    private void ToggleSidebar() => _navCollapsed = !_navCollapsed;

    private void OnMouseDown(MouseEventArgs e)
    {
        _isResizing = true;
        _startX = e.ClientX;
        _startWidth = _rightPanelWidth;
    }

    private void OnMouseMove(MouseEventArgs e)
    {
        if (!_isResizing) return;

        // Calculate new width (moving left increases width, moving right decreases width)
        var deltaX = _startX - e.ClientX;
        var newWidth = _startWidth + deltaX;

        // Constrain width between min and max values
        if (newWidth >= 600 && newWidth <= 1600)
        {
            _rightPanelWidth = newWidth;
        }
    }

    private void OnMouseUp(MouseEventArgs e)
    {
        _isResizing = false;
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        TitleService.OnTitleChanged += HandleTitleChanged;
    }

    private void HandleTitleChanged()
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        TitleService.OnTitleChanged -= HandleTitleChanged;
    }
}
